[(#REM)
Modèle d'affichage de la carte GIS. Paramètres
-id_carte_gis
-icon_size : taille max des icones
]

<script type="text/javascript">
	if (document.namespaces) { // only needed in IE
		document.namespaces.add("v", "urn:schemas-microsoft-com:vml");
	}

	//<![CDATA[	
		[(#SET{id_carte_gis,#ENV{id_carte_gis,1}})]

		[(#REM)Variables]
			<INCLURE{fond=inc_public_map_var}{id_carte_gis=#GET{id_carte_gis}}>
			var markerManager[(#GET{id_carte_gis})];
			var kml = new GGeoXml;
		
	function load[(#GET{id_carte_gis})]() {
		if (GBrowserIsCompatible()) {
			
			[(#REM)Partie générique]
				<INCLURE{fond=inc_public_map_gen}{id_carte_gis=#GET{id_carte_gis}}{env}>
		
			[(#REM)Réglages min et max zooms]
				G_MARS_ELEVATION_MAP.getMinimumResolution = function () { return 2 };
				G_MARS_ELEVATION_MAP.getMaximumResolution = function () { return 8 }; 		

			[(#REM)Partie spécifique]
				markerManager[(#GET{id_carte_gis})] = new GMarkerManager(map[(#GET{id_carte_gis})]);
				
				// Chargement KML si attache a l'article
					<BOUCLE_kml_art(documents){id_article}{0,1}{extension=kml}>
					[(#ENV{id_article}|=={''}|?{'',
					kml = new GGeoXml("[(#URL_DOCUMENT|url_absolue)]");
					map[(#GET{id_carte_gis})].addOverlay(kml);
					})]
					</BOUCLE_kml_art>
			
				// Chargement KML si attache a la rubrique
					<BOUCLE_kml_rub(documents){id_rubrique}{0,1}{extension=kml}>
					[(#ENV{id_rubrique}|=={''}|?{'',
					kml = new GGeoXml("[(#URL_DOCUMENT|url_absolue)]");
					map[(#GET{id_carte_gis})].addOverlay(kml);
					})]
					</BOUCLE_kml_rub>
					<//B_kml_art>

				//Markers construction
					[(#ENV{recursive}|=={1}|oui)
			   			jQuery.get('[(#URL_PAGE{rss-gis-recursive})]', {[limit:(#ENV{limit, 50})][, id_rubrique:(#ID_RUBRIQUE)][, id_parent:(#ID_RUBRIQUE)][, id_secteur:(#ID_SECTEUR)][, id_mot:(#ID_MOT)][, id_auteur:(#ID_AUTEUR)][, recherche:(#RECHERCHE)][, id_article:(#ID_ARTICLE)][, id_groupe:(#ID_GROUPE)][, icon_size:(#ICON_SIZE)][, draggable:'(#DRAGGABLE)'][, voir:'(#VOIR)']}, function(xml[(#GET{id_carte_gis})])
			   			{
					]
					[(#ENV{recursive}|=={1}|non)
						jQuery.get('[(#URL_PAGE{rss-gis})]', {[limit:(#ENV{limit, 50})][, id_rubrique:(#ID_RUBRIQUE)][, id_secteur:(#ID_SECTEUR)][, id_mot:(#ID_MOT)][, id_auteur:(#ID_AUTEUR)][, recherche:(#RECHERCHE)][, id_article:(#ID_ARTICLE)][, id_groupe:(#ID_GROUPE)][, icon_size:(#ICON_SIZE)][, draggable:'(#DRAGGABLE)'][, voir:'(#VOIR)']}, function(xml[(#GET{id_carte_gis})])
						{
					]
						//xml almacena en un objeto xml los datos recogidos del documento leido
							jQuery("item", xml[(#GET{id_carte_gis})]).each(function(item[(#GET{id_carte_gis})])
							{
								var xmlItem[(#GET{id_carte_gis})] = xml[(#GET{id_carte_gis})].documentElement.getElementsByTagName("item")[item[(#GET{id_carte_gis})]];
								agregarmarker(xmlItem[(#GET{id_carte_gis})],'[(#GET{id_carte_gis})]',0,17,markerManager[(#GET{id_carte_gis})][(#ENV{ombre}|=={0}|non),'ombre']);
							});
							markerManager[(#GET{id_carte_gis})].refresh();
							
						//Polyline
							[(#POLYLINE|oui)
								//kml = new GGeoXml("http://pipes.yahoo.com/pipes/pipe.run?_id=MGYBl4H52xGXVIf6y6ky6g&_render=kml");
								kml = new GGeoXml("[(#URL_PAGE{rss-kml-polyline}|parametre_url{id_rubrique,#ID_RUBRIQUE}|parametre_url{id_secteur,#ID_SECTEUR}|url_absolue|html_entity_decode)]");
								map[(#GET{id_carte_gis})].addOverlay(kml);
							]
							
							[(#ENV{attente}|=={1}|oui) $('#attente[(#GET{id_carte_gis})]').hide('normal'); ]
		   				});
		   				
		   	}
		   		
		}
		[(#ENV{load_map}|!={'non'}|oui)
		jQuery(document).ready(function(){
			load[(#GET{id_carte_gis})]();
			[(#ENV{attente}|=={1}|oui) $("#map[(#GET{id_carte_gis})]").append('<div id="attente[(#GET{id_carte_gis})]" style="position: absolute; z-index: 1000; top: 0; left: 0; background-color: #FFFFFF; filter:alpha(opacity=70); -moz-opacity: 0.7; opacity: 0.7;[ width: (#ENV{largeur});][ height: (#ENV{hauteur});]"><span style="display: block; width: 100%; height: 100%; background: transparent url([(#CHEMIN{img_pack/attente.gif})]) center center no-repeat;"></span></div>'); ]
		});]
	//]]>
</script>
